# Lossy Counting

Lossy Counting — это вероятностный алгоритм для идентификации частых элементов в потоке данных с контролируемой погрешностью.
Алгоритм решает задачу поиска элементов, чья частота превышает заданный минимальный порог $s$ (support), при этом гарантируя, что:
- Все истинно частые элементы будут обнаружены
- Частота каждого элемента может быть занижена не более чем на $εN$, где $ε$ — допустимая погрешность

Ключевая особенность реализации — автоматический контроль размера хеш-таблицы $D$, хранящей элементы и их счётчики.
Алгоритм поддерживает размер $D$ в пределах $O(1/ε)$ за счёт периодического удаления элементов, удовлетворяющих условию $f + Δ ≤ b$, где:
- $f$ — текущая оценка частоты элемента
- $Δ$ — максимальная ошибка в частоте
- $b$ — номер текущего блока данных

## Особенности реализации

* Поддержка пользовательских хэш-функций
* Шардирование для работы в многопоточной среде
* Коробочное покрытие метриками

## Математические основы

Алгоритм основан на следующих теоретических положениях:

1. **Гарантии точности**:
    - Все элементы с частотой $f ≥ sN$ будут найдены
    - Для каждого найденного элемента $f ≥ (s - ε)N$

2. **Оценка памяти**:
   Размер таблицы $D$ ограничен сверху:
   
$$
|D| \leq \frac{1}{\varepsilon} \log(\varepsilon N)
$$

3. **Параметры алгоритма**:
    - $ε$ — допустимая погрешность (должна быть меньше $s$)
    - $w = \lceil 1/ε \rceil$ — размер блока обработки

## Использование

```go
package main

import (
	"fmt"

	"github.com/koykov/hash/xxhash"
	"github.com/koykov/pbtk/heavy/lossy"
)

const (
	epsilon = 0.01
	support = 0.02
)

func main() {
	hasher := xxhash.Hasher64[[]byte]{}
	hitter, err := lossy.NewHitter[string](lossy.NewConfig(epsilon, support, hasher))
	_ = err
	oftenKey := "key0"
	for i := 0; i < 1000; i++ {
		key := fmt.Sprintf("key%d", i)
		_ = hitter.Add(key)
		if i%5 == 0 {
			_ = hitter.Add(oftenKey)
		}
	}
	hits := hitter.Hits()
	fmt.Printf("%+v", hits) // [{Key:key0 Rate:0.45318965517241383} {Key:key325 Rate:0.024132231404958678} ... {Key:key880 Rate:0.024132231404958678}]
}
```

## Области применения

* Анализ логов: поиск частых ошибок или шаблонов запросов.
* Рекомендательные системы: выявление популярных товаров/контента.
* Сетевой мониторинг: детектирование DDoS-атак (аномально частые запросы).

## Заключение

Представленная реализация Lossy Counting на Golang предоставляет:

* Эффективный потоковый алгоритм для поиска частых элементов
* Масштабируемость в многопоточной среде
* Контроль использования памяти
* Готовую интеграцию с системами мониторинга

Алгоритм особенно полезен в системах обработки потоковых данных, где требуется оперативное выявление популярных элементов
с гарантированной точностью при ограниченных ресурсах.
