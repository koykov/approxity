# Space-Saving Stream Summary

Алгоритм Space-Saving решает задачу поиска наиболее частых элементов (heavy hitters) в потоке данных, используя ограниченное количество памяти.

Основные свойства:

* Подходит для **потоковой обработки** (данные поступают непрерывно).
* Гарантирует, что элементы с высокой частотой будут обнаружены.
* Использует **фиксированное число счетчиков** (не хранит весь поток).

Формула обновления счетчика (классическая версия):
- Если элемент уже отслеживается:  
  
$$
\text{count}[x] \leftarrow \text{count}[x] + j
$$

- Если элемент новый, заменяет элемент с минимальным счетчиком:  
  
$$
\text{count}[x_{\text{new}}] \leftarrow \text{count}[x_{\text{min}}] + j
$$

## Особенности реализации

* Поддержка пользовательских хэш-функций
* Шардирование для работы в многопоточной среде
* EWMA-сглаживание для устранения аномальных всплесков частот
* Коробочное покрытие метриками

## EWMA для сглаживания пиков

Чтобы избежать нереалистичного роста счетчиков, используется **Exponentially Weighted Moving Average (EWMA)**:

$$
\text{count}[x] \leftarrow \alpha \cdot j + (1 - \alpha) \cdot \text{count}[x]
$$

Параметры:
* **α (коэффициент сглаживания)** — определяет, насколько сильно новые данные влияют на счетчик (обычно `0.01 ≤ α ≤ 0.1`).
* Чем меньше **α**, тем плавнее изменения (но медленнее реакция на новые данные).

## Использование

```go
package main

import (
	"fmt"

	"github.com/koykov/hash/xxhash"
	"github.com/koykov/pbtk/heavy/spacesaving"
)

const (
	K         = 5
	alphaEWMA = 0.999
)

func main() {
	hasher := xxhash.Hasher64[[]byte]{}
	hitter, err := spacesaving.NewHitter[string](spacesaving.NewConfig(K, hasher).
		WithEWMA(alphaEWMA))
	_ = err
	oftenKey := "key0"
	for i := 0; i < 1000; i++ {
		key := fmt.Sprintf("key%d", i)
		_ = hitter.Add(key)
		if i%2 == 0 {
			_ = hitter.Add(oftenKey)
		}
	}
	hits := hitter.Hits()
	fmt.Printf("%+v", hits) // [{Key:key0 Rate:649.3094164130389} {Key:key992 Rate:1} {Key:key4 Rate:1} {Key:key24 Rate:1} {Key:key999 Rate:1}]
}
```

## Области применения

1. **Анализ сетевого трафика** (поиск DDoS-атак, топ IP-адресов).
2. **Рекомендательные системы** (топ просматриваемых товаров).
3. **Логи веб-приложений** (поиск частых ошибок).
4. **Анализ поисковых запросов** (тренды, популярные ключевые слова).
5. **Обработка данных сенсоров** (аномалии, частые события).

## Заключение

Реализация **Space-Saving** с поддержкой **EWMA, шардирования и метрик** позволяет:  
* Эффективно находить частые элементы в потоке данных.  
* Работать в **многопоточной среде** без сильных накладных расходов.  
* Избегать аномального роста счетчиков за счёт **EWMA**.  
* Легко интегрироваться в мониторинг благодаря **метрикам**.

Алгоритм особенно полезен в **real-time analytics**, **мониторинге** и **выявлении аномалий**.
